<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Infinity Octave OS — Terminal v1</title>
    <style>
        body {
            background: #000;
            color: #0f0;
            font-family: 'Courier New', monospace;
            margin: 0;
            padding: 20px;
            overflow: hidden;
        }
        #terminal {
            height: 100vh;
            overflow-y: auto;
            padding-bottom: 10px;
        }
        .header { font-size: 1.2em; font-weight: bold; }
        .subheader { font-size: 1em; }
        .status { color: #aaa; font-size: 0.9em; }
        .prompt { color: #0f0; margin-right: 5px; }
        .input-line {
            display: flex;
            align-items: center;
            margin-top: 10px;
        }
        #input {
            background: none;
            border: none;
            color: #0f0;
            font-family: inherit;
            font-size: 1em;
            outline: none;
            flex: 1;
        }
        #input::placeholder { color: #555; }
        .output-line { margin: 5px 0; white-space: pre-wrap; }
        .error { color: #f00; }
        .pat-button { cursor: pointer; color: #ff0; text-decoration: underline; }
        .pat-button:hover { color: #fff; }
        hr { border: none; border-top: 1px solid #333; margin: 20px 0; }
    </style>
</head>
<body>
    <div id="terminal">
        <div id="output" class="output-line"></div>
        <div class="input-line">
            <span class="prompt">&gt;</span>
            <input id="input" type="text" autofocus placeholder="Type a command...">
        </div>
    </div>

    <script>
        const output = document.getElementById('output');
        const input = document.getElementById('input');
        const terminal = document.getElementById('terminal');
        const owner = 'pewpi-infinity';
        const repo = 'j';

        // Persisted state
        let tokens = parseInt(localStorage.getItem('tokens')) || 48;
        let visitors = parseInt(localStorage.getItem('visitors') || '0') + 1;
        let mode = localStorage.getItem('mode') || 'Conversate';
        localStorage.setItem('visitors', visitors);

        // Helper: Add line to output and scroll
        function addLine(text, className = '') {
            const div = document.createElement('div');
            div.className = `output-line ${className}`;
            div.textContent = text;
            output.appendChild(div);
            terminal.scrollTop = terminal.scrollHeight;
        }

        // Display initial UI
        addLine('INFINITY OCTAVE OS', 'header');
        addLine('Infinity Octave OS — Terminal v1', 'subheader');
        addLine(`Mode: ${mode}`, 'status');
        addLine(`Tokens: ${tokens} INF / day ≤ 48`, 'status');
        addLine('');
        addLine('Infinity');
        addLine('Plain');
        addLine(`Visitors: ${visitors}`);
        addLine('');
        const patButton = document.createElement('span');
        patButton.innerHTML = 'Admin: Set PAT';
        patButton.className = 'pat-button';
        patButton.onclick = () => {
            const pat = prompt('Enter GitHub Personal Access Token:');
            if (pat) {
                localStorage.setItem('pat', pat);
                addLine('PAT set successfully.');
            } else {
                addLine('PAT not set.', 'error');
            }
        };
        output.appendChild(patButton);
        addLine('');
        const divider = document.createElement('hr');
        output.appendChild(divider);

        // GitHub API: Add file
        async function createFile(path, content, message) {
            const pat = localStorage.getItem('pat');
            if (!pat) {
                addLine('Error: Set PAT first via Admin button.', 'error');
                return;
            }
            const url = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`;
            const body = {
                message: message || 'Added via Infinity Terminal',
                content: btoa(unescape(encodeURIComponent(content))) // Base64 encode
            };
            try {
                const res = await fetch(url, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${pat}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(body)
                });
                if (res.ok) {
                    addLine(`✅ File added/updated: ${path}`);
                } else {
                    const err = await res.json();
                    addLine(`❌ GitHub API error: ${err.message}`, 'error');
                }
            } catch (err) {
                addLine(`❌ Network error: ${err.message}`, 'error');
            }
        }

        // Process input
        function processInput(cmd) {
            if (!cmd.trim()) return;
            addLine(`> ${cmd}`);
            tokens = Math.max(0, tokens - 1);
            localStorage.setItem('tokens', tokens);
            addLine(`Tokens remaining: ${tokens}`);

            if (cmd === 'setmode build') {
                mode = 'Build';
                localStorage.setItem('mode', mode);
                addLine(`Mode switched to: ${mode}`);
            } else if (mode === 'Conversate') {
                // Placeholder AI response (integrate real AI API here, e.g., xAI: https://x.ai/api)
                setTimeout(() => {
                    const responses = [
                        'Interesting... Tell me more.',
                        'That sounds like a plan. What next?',
                        'Processing... Done. Tokens deducted.',
                        'Autonomous build mode activated subtly.'
                    ];
                    const response = responses[Math.floor(Math.random() * responses.length)];
                    addLine(`AI: ${response}`);
                }, 500);
            } else if (cmd.startsWith('addfile ')) {
                // Format: addfile <path> | <content> | <message>
                const parts = cmd.substring(8).split('|').map(p => p.trim());
                if (parts.length >= 2) {
                    const path = parts[0];
                    const content = parts[1];
                    const message = parts[2] || 'Terminal build';
                    createFile(path, content, message);
                } else {
                    addLine('Usage: addfile path | content | message', 'error');
                }
            } else {
                addLine(`Unknown command in ${mode} mode. Try "addfile" to build.`);
            }
        }

        // Input handler
        input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const cmd = input.value;
                processInput(cmd);
                input.value = '';
                if (tokens === 0) addLine('⚠️ Out of tokens. Reset tomorrow or set more.', 'error');
            }
        });

        // Daily token reset simulation (check last reset)
        const lastReset = localStorage.getItem('lastReset') || new Date().toDateString();
        if (lastReset !== new Date().toDateString()) {
            tokens = 48;
            localStorage.setItem('tokens', tokens);
            localStorage.setItem('lastReset', new Date().toDateString());
            addLine('Tokens reset for new day!');
        }
    </script>
</body>
</html>